/* ********************************************************************************
 * The content of this file is subject to the VTFarsi.ir Modules License("License");
 * You may not use this file except in compliance with the License
 * The Initial Developer of the Original Code is VTFarsi.ir
 * Portions created by VTFarsi.ir. are Copyright(C) VTFarsi Team
 * All Rights Reserved.
 * ****************************************************************************** */
var ParsVTMisc={showContent:function(e,t){return app.helper.showProgress(),t.module=app.getModuleName(),t.parent=app.getParentModuleName(),t.action=app.view(),t.mode="getContent",t.type=e,AppConnector.request(t).then((function(t){app.helper.hideProgress(),t.success&&(jQuery("#"+e).html(t.result.message),vtUtils.enableTooltips(),jQuery("#crontaskid").length>0&&app.showSelect2ElementView(jQuery("#crontaskid")),jQuery("#tofield").length>0&&(app.showSelect2ElementView(jQuery("#checkfield")),app.showSelect2ElementView(jQuery("#fromfield")),app.showSelect2ElementView(jQuery("#tofield"))),jQuery("#modtrackermodule").length>0&&app.showSelect2ElementView(jQuery("#modtrackermodule")),jQuery("#SystemCleanup").has("input.dateField").length>0?vtUtils.registerEventForDateFields(jQuery("#SystemCleanup")):jQuery("#SystemCleanup").has("input.timepicker-default").length>0&&vtUtils.registerEventForTimeFields(jQuery("#SystemCleanup")))}),(function(e){console.log("error =",e),app.helper.hideProgress()})),!1},GeneralOptions:function(e,t,s){if(app.helper.showProgress(),void 0===t)t={};return t.module=app.getModuleName(),t.parent=app.getParentModuleName(),t.action=app.view(),t.mode=e,AppConnector.request(t).then((function(e){app.helper.hideProgress(),e.success&&(app.helper.showSuccessNotification({message:e.result.message}),e.result.refresh&&(app.storage.delete("ParsVTTime"),setTimeout((function(){window.location.reload(1)}),3e3)))}),(function(e){console.log("error =",e),e.message&&app.helper.showErrorNotification({message:e.message}),app.helper.hideProgress()})),!1},showSQLReports:function(){app.helper.showProgress(app.vtranslate("JSLBL_Loading_Please_Wait")+"..."),app.request.get({url:"index.php?module=ParsVT&parent=Settings&view=SQLReportsModalAjax"}).then((function(e,t){app.helper.hideProgress(),null===e?t?app.helper.showModal(t):(app.helper.showErrorNotification({message:"Invalid Request!"}),app.helper.hideModal()):app.helper.showErrorNotification({message:e.message})}))},showCustomLinks:function(){app.helper.showProgress(app.vtranslate("JSLBL_Loading_Please_Wait")+"..."),app.request.get({url:"index.php?module=ParsVT&parent=Settings&view=CustomLinksModalAjax"}).then((function(e,t){app.helper.hideProgress(),null===e?t?app.helper.showModal(t):(app.helper.showErrorNotification({message:"Invalid Request!"}),app.helper.hideModal()):app.helper.showErrorNotification({message:e.message})}))},showDDU:function(){app.helper.showProgress(app.vtranslate("JSLBL_Loading_Please_Wait")+"..."),app.request.get({url:"index.php?module=ParsVT&parent=Settings&view=DDUModalAjax"}).then((function(e,t){app.helper.hideProgress(),null===e?t?app.helper.showModal(t):(app.helper.showErrorNotification({message:"Invalid Request!"}),app.helper.hideModal()):app.helper.showErrorNotification({message:e.message})}))},downloadCustomLinks:function(){app.helper.showProgress();var e={module:app.getModuleName(),parent:app.getParentModuleName(),action:app.view(),mode:"downloadCustomLinks"};AppConnector.request(e).then((function(e){app.helper.hideProgress(),e.success&&(e.result.success?app.helper.showSuccessNotification({message:e.result.message}):app.helper.showErrorNotification({message:e.result.message}),e.result.refresh&&(app.helper.hideModal(),setTimeout((function(){window.location.reload(1)}),3e3)))}),(function(e){console.log("error =",e),app.helper.hideProgress()}))},downloadSQLReports:function(){app.helper.showProgress();var e={module:app.getModuleName(),parent:app.getParentModuleName(),action:app.view(),mode:"downloadSQL"};AppConnector.request(e).then((function(e){app.helper.hideProgress(),e.success&&(e.result.success?app.helper.showSuccessNotification({message:e.result.message}):app.helper.showErrorNotification({message:e.result.message}),e.result.refresh&&(app.helper.hideModal(),setTimeout((function(){window.location.reload(1)}),3e3)))}),(function(e){console.log("error =",e),app.helper.hideProgress()}))},downloadDDU:function(){app.helper.showProgress();var e={module:app.getModuleName(),parent:app.getParentModuleName(),action:app.view(),mode:"downloadDDU"};AppConnector.request(e).then((function(e){app.helper.hideProgress(),e.success&&(e.result.success?app.helper.showSuccessNotification({message:e.result.message}):app.helper.showErrorNotification({message:e.result.message}),e.result.refresh&&(app.helper.hideModal(),setTimeout((function(){window.location.reload(1)}),3e3)))}),(function(e){console.log("error =",e),app.helper.hideProgress()}))},showMarkDown:function(e){var t=.8*window.innerHeight,s=.7*window.innerWidth;app.helper.showProgress();var o={};o.module=app.getModuleName(),o.parent=app.getParentModuleName(),o.action=app.view(),o.mode="showMarkDown",o.md=e,AppConnector.request(o).then((function(e){if(app.helper.hideProgress(),e.success&&e.result.title){var o='<div class="modal-dialog" style="width:'+s+"px; height:"+t+'px"> <div class="modal-header"> <div class="clearfix"> <div class="pull-right " ><button type="button" class="close" aria-label="Close" data-dismiss="modal"><span aria-hidden="true" class="fa fa-close"></span></button></div><h4 class="pull-left">'+e.result.title+'</h4> </div></div><div class="modal-content" style="max-width:'+s+"px; max-height:"+t+'px;"><div class="container-fluid"><div class="row-fluid formatted">'+e.result.content+"</div></div></div></div>";app.helper.showModal(o),app.helper.showVerticalScroll(jQuery(".modal-content"))}else app.helper.showErrorNotification({message:e.message})}),(function(e){console.log("error =",e),app.helper.hideProgress()}))},showHelp:function(e,t){if(t.startsWith("index.php"))window.open(t,"_blank");else{app.helper.showProgress();var s=t.includes("DBManager")||t.includes("FManager"),o=window.innerHeight*(s?.9:.8),a=window.innerWidth*(s?.8:.7),r='<div class="modal-dialog" style="'+(s?"margin:0":"")+";width:"+a+"px; height:"+o+'px"> <div class="modal-header"> <div class="clearfix"> <div class="pull-right " ><button type="button" class="close" aria-label="Close" data-dismiss="modal"><span aria-hidden="true" class="fa fa-close"></span></button></div><h4 class="pull-left">'+e+'</h4> </div></div><div class="modal-content"><iframe id="iframeModalWindow" style="width:'+(s?"100vw":a+"px")+"; height:"+(s?"100vh":o+"px")+'" scrolling="yes" src="'+t+'" name="iframe_modal"></iframe></div></div>';app.helper.showModal(r),$("#iframeModalWindow").load((function(){app.helper.hideProgress()}))}},showTools:function(e,t){if(t.startsWith("index.php"))window.open(t,"_blank");else{app.helper.showProgress();var s=t.includes("DBManager")||t.includes("FManager"),o=window.innerHeight*(s?.9:.8),a=window.innerWidth*(s?.8:.7),r='<div id="closeToolsModal" class="hide" style="#background-color: white; width: 25px; height: 25px; float: right; position: fixed; right: 35px; top: 10px; margin: 0 auto; align-items: center; display: flex; justify-content: center; align-content: center;"><a style="cursor: pointer;" onclick="ParsVTMisc.closeModal()"> <i class="fa fa-2x fa-close" style="color:red"></i></a></div><div style="background-color: #cacaca; width: 100%;"><iframe id="iframeModalWindow" style="width:'+(s?"100vw":a+"px")+"; height:"+(s?"100vh":o+"px")+'" scrolling="yes" src="'+t+'" name="iframe_modal"></iframe></div>';app.helper.loadPageOverlay(r,{ignoreScroll:!0,backdrop:"static"}).then((function(){$("#overlayPage").find(".data").css("height","300vh"),$("#overlayPage").css("top","0px"),$("#overlayPage").find(".modal-body").css("overflow","auto");var e=$(".modal-header");e.position();app.helper.showVerticalScroll(jQuery(".modal-body"),{setHeight:window.innerHeight-85-e.height()+"px"}),$("body").css("overflow-y","hidden"),$("body").css("overflow-x","hidden")})),app.helper.hideProgress(),$("#iframeModalWindow").load((function(){$("#closeToolsModal").removeClass("hide")}))}},closeModal:function(){$("#overlayPage").modal("hide"),$("body").css("overflow-y","auto"),$("body").css("overflow-x","auto");var e="index.php?module="+app.getModuleName()+"&action=ActionAjax&mode=ClearModalSession";app.request.get({url:e})}};jQuery.Class("ParsVT_Misc_Js",{},{registerActionEvent:function(){"Development"===app.view()&&$("#ParsVTToolsSettingsMainPanel").find("[data-parsvttools-action]").on("click",(function(e){e.preventDefault();var t=jQuery.Deferred();var s={};return $(this).closest("div.tool-panel").find(":input"+["button","input[type=button]","input[type=submit]","input[type=reset]"].map((e=>`:not(${e.trim()})`)).join("")).each((function(e,t){if($(t).is("input[type=checkbox], input[type=radio]")&&!$(t).prop("checked"))return;let o="";o=$(t).attr("name")?$(t).attr("name"):$(t).attr("id")?$(t).attr("id"):$(t).prop("nodeName").toLowerCase()+"_"+e,s[o]=$(t).val()})),params={module:"ParsVT",parent:"Settings",action:"Development",mode:"ToolAction",toolAction:$(this).attr("data-parsvttools-action"),index:"all",data:s},app.helper.showProgress(),app.request.post({data:params}).then((function(e,s){if(app.helper.hideProgress(),null===e){var o=""!=s?JSON.parse(s):{};if(!("error"in o)&&(!("success"in o)||"success"in o&&o.success)){if("message"in o||(o.message=app.vtranslate("JS_SAVED_SUCCESSFULLY")),$("#resultContainer").html(o.result),app.helper.showSuccessNotification(o),"reload"in o&&o.reload&&setTimeout(window.location.reload(),2e3),"callback"in o&&o.callback){new Function("data",o.callback)(o)}}else"message"in o||(o.message=app.vtranslate("Error")),app.helper.showErrorNotification(o);t.resolve(s)}else t.reject()})),t.promise()}))},registerEditGoogleAPIEvent:function(){$("#googleapi").click((function(e){app.request.get({url:"index.php?module=ParsVT&parent=Settings&view=GoogleAPISettings&mode=showGoogleAPI"}).then((function(e,t){null===e?app.helper.showModal(t):app.helper.showErrorNotification({message:e.message})}))})),$("#googlecapchaapi").click((function(e){app.request.get({url:"index.php?module=ParsVT&parent=Settings&view=GoogleAPISettings&mode=showreCapchaAPI"}).then((function(e,t){null===e?app.helper.showModal(t):app.helper.showErrorNotification({message:e.message})}))}))},registerEditHtaccessEvent:function(){var e=this;$("#edithtaccess").click((function(t){app.request.get({url:"index.php?module=ParsVT&parent=Settings&view=HtaccessSettings"}).then((function(t,s){null===t?(e.registerLoadHtaccessEditorEvent(),app.helper.showModal(s)):app.helper.showErrorNotification({message:t.message})}))}))},registerEditCreatorEvent:function(){$("#SMSNotifierModule").click((function(e){app.helper.showProgress(),app.request.get({url:"index.php?module=ParsVT&parent=Settings&view=SMSNotifier"}).then((function(e,t){null===e?(app.helper.hideProgress(),app.helper.showModal(t)):(app.helper.hideProgress(),app.helper.showErrorNotification({message:e.message}))}))})),$("#editcreator").click((function(e){app.helper.showProgress(),app.request.get({url:"index.php?module=ParsVT&parent=Settings&view=CreatorSettings"}).then((function(e,t){null===e?(app.helper.hideProgress(),app.helper.showModal(t)):(app.helper.hideProgress(),app.helper.showErrorNotification({message:e.message}))}))})),$("#editrecordid").click((function(e){app.helper.showProgress(),app.request.get({url:"index.php?module=ParsVT&parent=Settings&view=RecordIDSettings"}).then((function(e,t){null===e?(app.helper.hideProgress(),app.helper.showModal(t)):(app.helper.hideProgress(),app.helper.showErrorNotification({message:e.message}))}))}))},registerLoadHtaccessEditorEvent:function(){var e=this;if(null!=document.getElementById("htaccess")){var t=document.getElementById("htaccess");CodeMirror.fromTextArea(t,{lineNumbers:!0,autoRefresh:!0,lineWrapping:!0,matchBrackets:!0,theme:"isotope"})}else setTimeout((function(){e.registerLoadHtaccessEditorEvent()}),300)},registerSendHtaccessPostEvent:function(e,t){var s=jQuery.progressIndicator({message:"",position:"html",blockInfo:{enabled:!0}}),o={};o.module=app.getModuleName(),o.action="HtaccessAjax",o.parent="Settings",o.content=e,o.orginal=t,AppConnector.request(o).then((function(e){s.progressIndicator({mode:"hide"}),e.success&&1==e.success?app.helper.showSuccessNotification({message:e.result}):e.error&&app.helper.showErrorNotification({message:e.error.message}),app.helper.hideModal()}),(function(e){s.progressIndicator({mode:"hide"}),app.helper.hideModal(),app.helper.showErrorNotification({message:ParsVTErrors.OPFAILED})}))},registerSaveHtaccessEvent:function(){var e=this;$(document).on("click","#SaveHtaccess",(function(){$.base64.utf8encode=!0;var t=$.base64.encode($("#htaccess").val());e.registerSendHtaccessPostEvent(t,0)})),$(document).on("click","#OrginalHtaccess",(function(){$.base64.utf8encode=!0;var t=$.base64.encode($("#htaccess").val());e.registerSendHtaccessPostEvent(t,1)}))},registerEventForSwitch:function(){$('a[data-toggle="tab"]').on("show.bs.tab",(function(e){var t=e.target.getAttribute("href");t.includes("#")&&(t=t.split("#")[1]);var s={};if(-1==jQuery("#"+t).html().indexOf("row-fluid"))switch(t){case"MiscConf":case"MiscDatabse":case"MiscStability":case"MiscSysInfo":case"MiscSysUsage":case"MiscSecurity":case"PublicDirStates":case"SystemCleanup":case"ForceScheduler":case"ManagePicklists":case"ExportCSV":case"MiscFilesPermissions":ParsVTMisc.showContent(t,s);break;case"MiscClientInfo":navigator.appVersion;var o,a,r,i=navigator.userAgent,n=navigator.appName,p=""+parseFloat(navigator.appVersion),l=parseInt(navigator.appVersion,10);-1!=(a=i.indexOf("OPR"))?(n="Opera",p=i.substring(a+4),-1!=(a=i.indexOf("Version"))&&(p=i.substring(a+8))):-1!=(a=i.indexOf("Edg"))?(n="Microsoft Edge",p=i.substring(a+4)):-1!=(a=i.indexOf("MSIE"))?(n="Microsoft Internet Explorer",p=i.substring(a+5)):-1!=(a=i.indexOf("Chrome"))?(n="Chrome",p=i.substring(a+7)):-1!=(a=i.indexOf("Safari"))?(n="Safari",p=i.substring(a+7),-1!=(a=i.indexOf("Version"))&&(p=i.substring(a+8))):-1!=(a=i.indexOf("Firefox"))?(n="Firefox",p=i.substring(a+8)):(o=i.lastIndexOf(" ")+1)<(a=i.lastIndexOf("/"))&&(n=i.substring(o,a),p=i.substring(a+1),n.toLowerCase()==n.toUpperCase()&&(n=navigator.appName)),-1!=(r=p.indexOf(";"))&&(p=p.substring(0,r)),-1!=(r=p.indexOf(" "))&&(p=p.substring(0,r)),l=parseInt(""+p,10),isNaN(l)&&(p=""+parseFloat(navigator.appVersion),l=parseInt(navigator.appVersion,10));var c=!!document.createElement("canvas").getContext,d="Unknown";-1!=window.navigator.userAgent.indexOf("Windows NT 10.0")&&(d="Windows 10"),-1!=window.navigator.userAgent.indexOf("Windows NT 6.3")&&(d="Windows 8.1"),-1!=window.navigator.userAgent.indexOf("Windows NT 6.2")&&(d="Windows 8"),-1!=window.navigator.userAgent.indexOf("Windows NT 6.1")&&(d="Windows 7"),-1!=window.navigator.userAgent.indexOf("Windows NT 6.0")&&(d="Windows Vista"),-1!=window.navigator.userAgent.indexOf("Windows NT 5.1")&&(d="Windows XP"),-1!=window.navigator.userAgent.indexOf("Windows NT 5.0")&&(d="Windows 2000"),-1!=window.navigator.userAgent.indexOf("Mac")&&(d="Mac/iOS"),-1!=window.navigator.userAgent.indexOf("X11")&&(d="UNIX"),-1!=window.navigator.userAgent.indexOf("Linux")&&(d="Linux");var u={};u.Browser=n+" v"+p,u["User Agent"]=navigator.userAgent,u["Cookie Enabled"]=navigator.cookieEnabled,u["HTML5 Enabled"]=c,u.OS=d,u["Screen Width"]=screen.width,u["Screen Height"]=screen.height,s.data=u,ParsVTMisc.showContent(t,s)}})),jQuery("#MiscGereral").on("switchChange.bootstrapSwitch","input[type=checkbox]",(function(e){var t=jQuery(e.currentTarget);1==t.val()?t.attr("value",0):t.attr("value",1);var s=t.data("type");ParsVTMisc.GeneralOptions(s,{value:t.val()})}))},registerSaveGoogleAPIEvent:function(){$(document).on("click","#SavereCapchaAPI",(function(){var e=jQuery.progressIndicator({message:"",position:"html",blockInfo:{enabled:!0}}),t=jQuery("input[name=publickey]").val(),s=jQuery("input[name=secretkey]").val(),o={};o.module=app.getModuleName(),o.mode="SavereCapchaAPI",o.action="GoogleAPIAjax",o.parent="Settings",o.publickey=t,o.secretkey=s,AppConnector.request(o).then((function(t){e.progressIndicator({mode:"hide"}),t.success&&1==t.success?app.helper.showSuccessNotification({message:t.result}):t.error&&app.helper.showErrorNotification({message:t.error.message}),app.helper.hideModal(),setTimeout((function(){window.location.reload(1)}),3e3)}),(function(t){e.progressIndicator({mode:"hide"}),app.helper.hideModal(),app.helper.showErrorNotification({message:ParsVTErrors.OPFAILED})}))})),$(document).on("click","#SaveGoogleAPI",(function(){var e=jQuery.progressIndicator({message:"",position:"html",blockInfo:{enabled:!0}}),t=jQuery("input[name=clientid]").val(),s=jQuery("input[name=clientsecret]").val(),o={};o.module=app.getModuleName(),o.mode="SaveGoogleAPI",o.action="GoogleAPIAjax",o.parent="Settings",o.clientid=t,o.clientsecret=s,AppConnector.request(o).then((function(t){e.progressIndicator({mode:"hide"}),t.success&&1==t.success?app.helper.showSuccessNotification({message:t.result}):t.error&&app.helper.showErrorNotification({message:t.error.message}),app.helper.hideModal(),setTimeout((function(){window.location.reload(1)}),3e3)}),(function(t){e.progressIndicator({mode:"hide"}),app.helper.hideModal(),app.helper.showErrorNotification({message:ParsVTErrors.OPFAILED})}))}))},updateModuleStatus:function(e,t,s){var o=app.vtranslate("Field updated");if(0==s)var a="UpdateCreatorField";else if(1==s)a="UpdateRecordIDField";else if(2==s){a="SMSNotifierRelation";o=app.vtranslate("Relation updated")}params={data:{module:"ParsVT",parent:"Settings",action:"Misc",mode:a,tabid:e,type:t}},app.helper.showProgress(),app.request.post(params).then((function(e,t){app.helper.hideProgress(),null===e&&app.helper.showSuccessNotification({message:o})}))},registerCreatorClickEvent:function(){var e=this;$(document).on("click",".creatorfield_checkbox",(function(){var t=jQuery(this),s=t.data(),o="Hide";"checked"===t.attr("checked")&&(o="Show"),e.updateModuleStatus(s.tabid,o,0)})),$(document).on("click",".recordidfield_checkbox",(function(){var t=jQuery(this),s=t.data(),o="Hide";"checked"===t.attr("checked")&&(o="Show"),e.updateModuleStatus(s.tabid,o,1)})),$(document).on("click",".phonefield_checkbox",(function(){var t=jQuery(this),s=t.data(),o="Hide";"checked"===t.attr("checked")&&(o="Show"),e.updateModuleStatus(s.tabid,o,2)}))},registerKeyUpEvent:function(){jQuery(".maintenance_contents").one("keyup","#maintenance_message",(function(e){jQuery(".saveMaintenanceAnnouncement").removeClass("hide")}))},registerSaveMaintenance:function(){var e=this,t=jQuery(".saveMaintenanceAnnouncement");t.click((function(s){t.addClass("hide"),e.saveAnnouncement().then((function(t){e.registerKeyUpEvent(),app.helper.showSuccessNotification({message:app.vtranslate("Announcement Saved")})}))}))},saveAnnouncement:function(){var e=jQuery.Deferred(),t=jQuery("#maintenance_message").val(),s=jQuery("#maintenance_userid").val(),o={module:app.getModuleName(),parent:app.getParentModuleName(),action:"Misc",mode:"MaintenanceMessage",announcement_content:t,announcement_userid:s};return app.request.post({data:o}).then((function(t,s){null===t?e.resolve():e.reject()})),e.promise()},registerEvents:function(){this.registerEditGoogleAPIEvent(),this.registerCreatorClickEvent(),this.registerEditHtaccessEvent(),this.registerEditCreatorEvent(),this.registerSaveGoogleAPIEvent(),this.registerSaveHtaccessEvent(),this.registerEventForSwitch(),this.registerKeyUpEvent(),this.registerSaveMaintenance(),this.registerActionEvent(),jQuery(".bootstrap-switch").bootstrapSwitch(),vtUtils.enableTooltips()}}),jQuery(document).ready((function(){(new ParsVT_Misc_Js).registerEvents()}));